// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// üè¢ TENANTS (Clientes del SaaS)
model Tenant {
  id        String   @id @default(cuid())
  slug      String   @unique
  name      String
  planType  String   @default("basic") @map("plan_type")
  status    String   @default("active")
  settings  Json     @default("{}")
  defaultDocumentClass String @default("invoice") @map("default_document_class") // Tipo de documento por defecto: invoice, quote, credit_note, debit_note
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Datos fiscales del tenant
  vatConditionId  String?  @map("vat_condition_id")
  cuit            String?

  // Relations
  tenantUsers       TenantUser[]
  documentTypes     DocumentType[]
  entities          Entity[]
  productCategories ProductCategory[]
  productBrands     ProductBrand[]
  customerCategories CustomerCategory[]
  taxes             Tax[]
  paymentMethods    PaymentMethod[]
  vatConditions     VatCondition[]
  tenantVatCondition VatCondition? @relation("TenantVatCondition", fields: [vatConditionId], references: [id])
  products          Product[]
  documents         Document[]
  documentItems     DocumentItem[]
  warehouses        Warehouse[]
  stockMovements    StockMovement[]
  stockAdjustments  StockAdjustment[]
  sales             Sale[]
  afipConfiguration AfipConfiguration?
  branches          Branch[]
  afipConnections   AfipConnection[]
  salesPoints       SalesPoint[]
  voucherConfigurations VoucherConfiguration[]
  purchases         Purchase[]
  cashAccounts      CashAccount[] @relation("CashAccountTenant")
  cashMovements     CashMovement[] @relation("CashMovementTenant")

  @@map("tenants")
}

// üë§ USUARIOS
model User {
  id           String    @id @default(cuid())
  email        String    @unique
  passwordHash String    @map("password_hash")
  firstName    String?   @map("first_name")
  lastName     String?   @map("last_name")
  isActive     Boolean   @default(true) @map("is_active")
  lastLoginAt  DateTime? @map("last_login_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // Relations
  tenantUsers      TenantUser[]
  createdDocuments Document[] @relation("DocumentCreatedBy")
  updatedDocuments Document[] @relation("DocumentUpdatedBy")
  stockMovements   StockMovement[]
  stockAdjustments StockAdjustment[]
  createdSales     Sale[] @relation("SaleCreatedBy")
  createdPurchases Purchase[] @relation("PurchaseCreatedBy")
  createdPurchasePayments PurchasePayment[] @relation("PurchasePaymentCreatedBy")
  createdCashAccounts CashAccount[] @relation("CashAccountCreatedBy")
  createdCashMovements CashMovement[] @relation("CashMovementCreatedBy")

  @@map("users")
}

// üîê RELACI√ìN TENANT-USER
model TenantUser {
  id          String   @id @default(cuid())
  tenantId    String   @map("tenant_id")
  userId      String   @map("user_id")
  role        String
  permissions Json     @default("[]")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tenantId, userId])
  @@map("tenant_users")
}

// üìã TIPOS DE DOCUMENTO
model DocumentType {
  id                    String   @id @default(cuid())
  tenantId              String   @map("tenant_id")
  code                  String
  name                  String
  description           String?
  documentType          String   @default("OTHER") @map("document_type") // INVOICE, CREDIT_NOTE, DEBIT_NOTE, RECEIPT, ORDER, QUOTE, OTHER
  prefix                String?
  requiresAuthorization Boolean  @default(false) @map("requires_authorization")
  hasElectronicBilling  Boolean  @default(false) @map("has_electronic_billing")
  category              String?
  config                Json     @default("{}")
  workflowConfig        Json     @default("{}") @map("workflow_config")
  isActive              Boolean  @default(true) @map("is_active")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  // Relations
  tenant    Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  documents Document[]

  @@unique([tenantId, code])
  @@map("document_types")
}

// üè¢ ENTIDADES (Pueden ser clientes, proveedores o ambos)
model Entity {
  id               String   @id @default(cuid())
  tenantId         String   @map("tenant_id")
  code             String?
  name             String
  taxId            String?  @map("tax_id")
  email            String?
  phone            String?
  addressLine1     String?  @map("address_line1")
  addressLine2     String?  @map("address_line2")
  city             String?
  state            String?
  postalCode       String?  @map("postal_code")
  country          String   @default("AR")
  // Roles que puede tener la entidad
  isCustomer       Boolean  @default(false) @map("is_customer")
  isSupplier       Boolean  @default(false) @map("is_supplier")
  isEmployee       Boolean  @default(false) @map("is_employee")
  category         String?
  currency         String   @default("ARS")
  // Configuraci√≥n para clientes
  customerPaymentTerms Int?   @map("customer_payment_terms")
  customerCreditLimit  Decimal? @map("customer_credit_limit") @db.Decimal(15, 2)
  isDefaultCustomer    Boolean @default(false) @map("is_default_customer")
  // Configuraci√≥n para proveedores
  supplierPaymentTerms Int?   @map("supplier_payment_terms")
  supplierCategory     String? @map("supplier_category")
  // Configuraci√≥n para empleados
  employeePosition     String? @map("employee_position")
  employeeSalary       Decimal? @map("employee_salary") @db.Decimal(15, 2)
  // Datos fiscales
  cuit                 String?
  ivaCondition         String? @map("iva_condition")
  grossIncomeNumber    String? @map("gross_income_number")
  businessActivity     String? @map("business_activity")
  metadata         Json     @default("{}")
  isActive         Boolean  @default(true) @map("is_active")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // Relations
  tenant               Tenant                      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customerCategories   EntityCustomerCategory[]
  documents            Document[]
  deliveryAddresses    EntityDeliveryAddress[]
  sales                Sale[]
  purchases            Purchase[] @relation("PurchaseSupplier")

  @@unique([tenantId, code])
  @@map("entities")
}

// üìç DIRECCIONES DE ENTREGA
model EntityDeliveryAddress {
  id           String  @id @default(cuid())
  entityId     String  @map("entity_id")
  name         String
  addressLine1 String  @map("address_line1")
  addressLine2 String? @map("address_line2")
  city         String
  state        String
  postalCode   String? @map("postal_code")
  isDefault    Boolean @default(false) @map("is_default")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  entity Entity @relation(fields: [entityId], references: [id], onDelete: Cascade)

  @@map("entity_delivery_addresses")
}

// üè∑Ô∏è CATEGOR√çAS DE PRODUCTOS
model ProductCategory {
  id        String   @id @default(cuid())
  tenantId  String   @map("tenant_id")
  name      String
  description String?
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  tenant   Tenant                   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  products ProductCategoryProduct[]

  @@unique([tenantId, name])
  @@map("product_categories")
}

// üè¢ MARCAS DE PRODUCTOS
model ProductBrand {
  id        String   @id @default(cuid())
  tenantId  String   @map("tenant_id")
  name      String
  description String?
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  tenant   Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  products ProductBrandProduct[]

  @@unique([tenantId, name])
  @@map("product_brands")
}

// üéØ CATEGOR√çAS DE CLIENTES
model CustomerCategory {
  id                 String   @id @default(cuid())
  tenantId           String   @map("tenant_id")
  name               String
  description        String?
  discountPercentage Decimal? @default(0) @map("discount_percentage") @db.Decimal(5, 2)
  paymentTerms       Int?     @map("payment_terms")
  isActive           Boolean  @default(true) @map("is_active")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  // Relations
  tenant   Tenant                     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  entities EntityCustomerCategory[]

  @@unique([tenantId, name])
  @@map("customer_categories")
}

// üßæ IMPUESTOS
model Tax {
  id          String   @id @default(cuid())
  tenantId    String   @map("tenant_id")
  name        String
  description String?
  rate        Decimal  @db.Decimal(5, 2)
  taxType     String   @map("tax_type") // VAT, INCOME, GROSS_INCOME, OTHER
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, name])
  @@map("taxes")
}

// üí≥ FORMAS DE PAGO
model PaymentMethod {
  id                String   @id @default(cuid())
  tenantId          String   @map("tenant_id")
  name              String
  description       String?
  paymentType       String   @map("payment_type") // CASH, TRANSFER, CHECK, CARD, OTHER
  requiresReference Boolean  @default(false) @map("requires_reference")
  daysToCollection  Int?     @default(0) @map("days_to_collection")
  isActive          Boolean  @default(true) @map("is_active")
  cashAccountId     String?  @map("cash_account_id") // Cuenta de caja asociada
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  tenant          Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  cashAccount     CashAccount?      @relation("PaymentMethodCashAccount", fields: [cashAccountId], references: [id], onDelete: SetNull)
  salePayments    SalePayment[]
  purchasePayments PurchasePayment[] @relation("PurchasePaymentMethod")
  cashMovements   CashMovement[] @relation("CashMovementPaymentMethod")

  @@unique([tenantId, name])
  @@map("payment_methods")
}

// üíº CONDICIONES DE IVA
model VatCondition {
  id             String   @id @default(cuid())
  tenantId       String   @map("tenant_id")
  name           String
  code           String
  description    String?
  taxRate        Decimal? @map("tax_rate") @db.Decimal(5, 2)
  isExempt       Boolean  @default(false) @map("is_exempt")
  isActive       Boolean  @default(true) @map("is_active")
  afipCode       Int?     @map("afip_code") // C√≥digo de condici√≥n IVA para AFIP (1=RI, 3=NR, 4=EX, 5=CF, 6=MT)
  afipDocumentType Int?   @map("afip_document_type") // Tipo de documento AFIP (80=CUIT, 86=CUIL, 96=DNI, 99=CF)
  canIssueA      Boolean  @default(false) @map("can_issue_a")
  issuesOnlyC    Boolean  @default(false) @map("issues_only_c")
  allowedVoucherTypes Json @default("[]") @map("allowed_voucher_types") // C√≥digos de comprobantes que puede emitir: ["FA", "FB", "FC", "NCA", etc]
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tenantsUsingThis Tenant[] @relation("TenantVatCondition")

  @@unique([tenantId, code])
  @@map("vat_conditions")
}

// üì¶ PRODUCTOS
model Product {
  id                 String  @id @default(cuid())
  tenantId           String  @map("tenant_id")
  sku                String
  name               String
  description        String?
  barcode            String?
  costPrice          Decimal @default(0) @map("cost_price") @db.Decimal(15, 4)
  salePrice          Decimal @default(0) @map("sale_price") @db.Decimal(15, 4)
  currency           String  @default("ARS")
  trackStock         Boolean @default(true) @map("track_stock")
  currentStock       Decimal @default(0) @map("current_stock") @db.Decimal(15, 4)
  minStock           Decimal @default(0) @map("min_stock") @db.Decimal(15, 4)
  weight             Decimal? @db.Decimal(10, 3)
  weightUnit         String? @map("weight_unit")
  dimensions         String?
  notes              String?
  showInQuickAccess  Boolean @default(false) @map("show_in_quick_access")
  abbreviation       String?
  metadata           Json    @default("{}")
  isActive           Boolean @default(true) @map("is_active")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  // Relations
  tenant              Tenant                   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  productCategories   ProductCategoryProduct[]
  productBrands       ProductBrandProduct[]
  documentItems       DocumentItem[]
  warehouseStocks     WarehouseStock[]
  stockMovements      StockMovement[]
  saleItems           SaleItem[]
  purchaseItems       PurchaseItem[] @relation("PurchaseItemProduct")

  @@unique([tenantId, sku])
  @@map("products")
}

// üìÑ DOCUMENTOS
model Document {
  id                   String   @id @default(cuid())
  tenantId             String   @map("tenant_id")
  documentTypeId       String   @map("document_type_id")
  number               String
  displayNumber        String?  @map("display_number")
  documentDate         DateTime @default(now()) @map("document_date") @db.Date
  dueDate              DateTime? @map("due_date") @db.Date
  entityId             String?  @map("entity_id")
  entityName           String?  @map("entity_name")
  subtotal             Decimal  @default(0) @db.Decimal(15, 2)
  taxAmount            Decimal  @default(0) @map("tax_amount") @db.Decimal(15, 2)
  totalAmount          Decimal  @default(0) @map("total_amount") @db.Decimal(15, 2)
  currency             String   @default("ARS")
  status               String   @default("draft")
  workflowStage        String?  @map("workflow_stage")
  metadata             Json     @default("{}")
  referenceDocumentId  String?  @map("reference_document_id")
  createdBy            String   @map("created_by")
  updatedBy            String?  @map("updated_by")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  // Relations
  tenant            Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  documentType      DocumentType   @relation(fields: [documentTypeId], references: [id])
  entity            Entity?        @relation(fields: [entityId], references: [id])
  referenceDocument Document?      @relation("DocumentReference", fields: [referenceDocumentId], references: [id])
  referencedBy      Document[]     @relation("DocumentReference")
  creator           User           @relation("DocumentCreatedBy", fields: [createdBy], references: [id])
  updater           User?          @relation("DocumentUpdatedBy", fields: [updatedBy], references: [id])
  items             DocumentItem[]
  sales             Sale[]

  @@unique([tenantId, documentTypeId, number])
  @@map("documents")
}

// üìù √çTEMS DE DOCUMENTO
model DocumentItem {
  id              String  @id @default(cuid())
  tenantId        String  @map("tenant_id")
  documentId      String  @map("document_id")
  lineNumber      Int     @map("line_number")
  productId       String? @map("product_id")
  productSku      String? @map("product_sku")
  description     String
  quantity        Decimal @db.Decimal(15, 4)
  unitPrice       Decimal @map("unit_price") @db.Decimal(15, 4)
  discountPercent Decimal @default(0) @map("discount_percent") @db.Decimal(5, 2)
  lineTotal       Decimal @map("line_total") @db.Decimal(15, 2)
  taxRate         Decimal @default(0) @map("tax_rate") @db.Decimal(5, 2)
  taxAmount       Decimal @default(0) @map("tax_amount") @db.Decimal(15, 2)
  metadata        Json    @default("{}")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  product  Product? @relation(fields: [productId], references: [id])

  @@map("document_items")
}

// üè≠ ALMACENES
model Warehouse {
  id          String   @id @default(cuid())
  tenantId    String   @map("tenant_id")
  code        String
  name        String
  description String?
  address     String?
  isActive    Boolean  @default(true) @map("is_active")
  isDefault   Boolean  @default(false) @map("is_default")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  tenant          Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  warehouseStocks WarehouseStock[]
  stockMovements  StockMovement[]
  stockAdjustments StockAdjustment[]
  sales           Sale[]
  purchases       Purchase[] @relation("PurchaseWarehouse")

  @@unique([tenantId, code])
  @@map("warehouses")
}

// üìä STOCK POR ALMAC√âN
model WarehouseStock {
  id            String   @id @default(cuid())
  tenantId      String   @map("tenant_id")
  warehouseId   String   @map("warehouse_id")
  productId     String   @map("product_id")
  quantity      Decimal  @db.Decimal(15, 4)
  reservedQty   Decimal  @default(0) @map("reserved_qty") @db.Decimal(15, 4)
  availableQty  Decimal  @map("available_qty") @db.Decimal(15, 4)
  lastMovement  DateTime? @map("last_movement")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  warehouse Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  product   Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([warehouseId, productId])
  @@map("warehouse_stocks")
}

// üì¶ MOVIMIENTOS DE STOCK
model StockMovement {
  id              String   @id @default(cuid())
  tenantId        String   @map("tenant_id")
  warehouseId     String   @map("warehouse_id")
  productId       String   @map("product_id")
  movementType    String   @map("movement_type") // IN, OUT, TRANSFER
  quantity        Decimal  @db.Decimal(15, 4)
  unitCost        Decimal? @map("unit_cost") @db.Decimal(15, 4)
  totalCost       Decimal? @map("total_cost") @db.Decimal(15, 4)
  documentType    String?  @map("document_type")
  documentId      String?  @map("document_id")
  referenceNumber String?  @map("reference_number")
  notes           String?
  userId          String   @map("user_id")
  createdAt       DateTime @default(now()) @map("created_at")

  // Relations
  tenant    Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  warehouse Warehouse @relation(fields: [warehouseId], references: [id])
  product   Product   @relation(fields: [productId], references: [id])
  user      User      @relation(fields: [userId], references: [id])

  @@index([tenantId, warehouseId, productId])
  @@index([tenantId, createdAt])
  @@map("stock_movements")
}

// üîß AJUSTES DE INVENTARIO
model StockAdjustment {
  id            String   @id @default(cuid())
  tenantId      String   @map("tenant_id")
  adjustmentNumber String @map("adjustment_number")
  warehouseId   String   @map("warehouse_id")
  adjustmentDate DateTime @map("adjustment_date") @db.Date
  reason        String
  status        String   @default("draft") // draft, approved, cancelled
  notes         String?
  totalValue    Decimal  @default(0) @map("total_value") @db.Decimal(15, 2)
  approvedBy    String?  @map("approved_by")
  approvedAt    DateTime? @map("approved_at")
  createdBy     String   @map("created_by")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  tenant    Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  warehouse Warehouse @relation(fields: [warehouseId], references: [id])
  creator   User      @relation(fields: [createdBy], references: [id])
  items     StockAdjustmentItem[]

  @@unique([tenantId, adjustmentNumber])
  @@map("stock_adjustments")
}

// üìù ITEMS DE AJUSTE
model StockAdjustmentItem {
  id              String  @id @default(cuid())
  adjustmentId    String  @map("adjustment_id")
  productId       String  @map("product_id")
  currentQty      Decimal @map("current_qty") @db.Decimal(15, 4)
  adjustedQty     Decimal @map("adjusted_qty") @db.Decimal(15, 4)
  difference      Decimal @db.Decimal(15, 4)
  unitCost        Decimal @map("unit_cost") @db.Decimal(15, 4)
  totalValue      Decimal @map("total_value") @db.Decimal(15, 2)
  reason          String?

  // Relations
  adjustment StockAdjustment @relation(fields: [adjustmentId], references: [id], onDelete: Cascade)

  @@map("stock_adjustment_items")
}

// üîó RELACIONES M:N

// Productos ‚Üî Categor√≠as
model ProductCategoryProduct {
  id         String          @id @default(cuid())
  productId  String          @map("product_id")
  categoryId String          @map("category_id")
  createdAt  DateTime        @default(now()) @map("created_at")

  // Relations
  product  Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  category ProductCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([productId, categoryId])
  @@map("product_category_products")
}

// Productos ‚Üî Marcas
model ProductBrandProduct {
  id        String       @id @default(cuid())
  productId String       @map("product_id")
  brandId   String       @map("brand_id")
  createdAt DateTime     @default(now()) @map("created_at")

  // Relations
  product Product      @relation(fields: [productId], references: [id], onDelete: Cascade)
  brand   ProductBrand @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@unique([productId, brandId])
  @@map("product_brand_products")
}

// Entidades ‚Üî Categor√≠as de Clientes
model EntityCustomerCategory {
  id                 String           @id @default(cuid())
  entityId           String           @map("entity_id")
  customerCategoryId String           @map("customer_category_id")
  createdAt          DateTime         @default(now()) @map("created_at")

  // Relations
  entity           Entity           @relation(fields: [entityId], references: [id], onDelete: Cascade)
  customerCategory CustomerCategory @relation(fields: [customerCategoryId], references: [id], onDelete: Cascade)

  @@unique([entityId, customerCategoryId])
  @@map("entity_customer_categories")
}

// üí∞ VENTAS
model Sale {
  id              String   @id @default(cuid())
  tenantId        String   @map("tenant_id")
  saleNumber      String   @map("sale_number")
  saleDate        DateTime @default(now()) @map("sale_date") @db.Date
  customerId      String?  @map("customer_id")
  customerName    String?  @map("customer_name")

  // Montos
  subtotal        Decimal  @default(0) @db.Decimal(15, 2)
  discountAmount  Decimal  @default(0) @map("discount_amount") @db.Decimal(15, 2)
  taxAmount       Decimal  @default(0) @map("tax_amount") @db.Decimal(15, 2)
  totalAmount     Decimal  @default(0) @map("total_amount") @db.Decimal(15, 2)

  // Estado de pago
  paidAmount      Decimal  @default(0) @map("paid_amount") @db.Decimal(15, 2)
  balanceAmount   Decimal  @default(0) @map("balance_amount") @db.Decimal(15, 2)
  paymentStatus   String   @default("pending") @map("payment_status") // pending, partial, paid

  // Facturaci√≥n AFIP (campos legacy - mantener por compatibilidad)
  invoiceId       String?  @map("invoice_id")
  afipStatus      String?  @default("not_sent") @map("afip_status")
  afipCae         String?  @map("afip_cae")
  afipCaeExpiry   DateTime? @map("afip_cae_expiry")
  voucherType     String?  @map("voucher_type")

  // Nueva estructura de facturaci√≥n
  branchId              String?  @map("branch_id")
  documentClass         String?  @map("document_class") // 'INVOICE', 'CREDIT_NOTE', 'DEBIT_NOTE', 'QUOTE'
  voucherTypeId         String?  @map("voucher_type_id")
  voucherConfigurationId String? @map("voucher_configuration_id")
  salesPointNumber      Int?     @map("sales_point_number")
  voucherNumber         Int?     @map("voucher_number")
  fullVoucherNumber     String?  @map("full_voucher_number")
  cae                   String?
  caeExpiration         DateTime? @map("cae_expiration")
  afipRequest           Json?    @map("afip_request")
  afipResponse          Json?    @map("afip_response")
  qrData                String?  @map("qr_data") @db.Text

  // Almac√©n de donde se descont√≥ el stock
  warehouseId     String?  @map("warehouse_id")

  // Tipo de cliente
  customerType    String   @default("final") @map("customer_type") // "registered", "final"

  // Descuento a nivel venta
  discountPercent Decimal  @default(0) @map("discount_percent") @db.Decimal(5, 2)

  // Metadatos
  notes           String?
  metadata        Json     @default("{}")

  // Auditor√≠a
  status          String   @default("completed") // draft, completed, cancelled
  createdBy       String   @map("created_by")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  tenant               Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customer             Entity?                @relation(fields: [customerId], references: [id])
  warehouse            Warehouse?             @relation(fields: [warehouseId], references: [id])
  invoice              Document?              @relation(fields: [invoiceId], references: [id])
  creator              User                   @relation("SaleCreatedBy", fields: [createdBy], references: [id])
  branch               Branch?                @relation("SaleBranch", fields: [branchId], references: [id])
  voucherTypeRelation  VoucherType?           @relation(fields: [voucherTypeId], references: [id])
  voucherConfiguration VoucherConfiguration?  @relation(fields: [voucherConfigurationId], references: [id])
  items                SaleItem[]
  payments             SalePayment[]
  cashMovements        CashMovement[] @relation("CashMovementSale")

  @@unique([tenantId, branchId, salesPointNumber, voucherNumber], name: "sale_unique_voucher")
  @@unique([tenantId, saleNumber])
  @@index([tenantId, saleDate])
  @@index([tenantId, paymentStatus])
  @@index([branchId])
  @@index([voucherTypeId])
  @@index([fullVoucherNumber])
  @@map("sales")
}

// üìù ITEMS DE VENTA
model SaleItem {
  id              String  @id @default(cuid())
  saleId          String  @map("sale_id")
  lineNumber      Int     @map("line_number")
  productId       String? @map("product_id")
  productSku      String? @map("product_sku")
  productName     String  @map("product_name")
  description     String?

  // Cantidades y precios
  quantity        Decimal @db.Decimal(15, 4)
  unitPrice       Decimal @map("unit_price") @db.Decimal(15, 4)
  discountPercent Decimal @default(0) @map("discount_percent") @db.Decimal(5, 2)
  discountAmount  Decimal @default(0) @map("discount_amount") @db.Decimal(15, 2)

  // Impuestos
  taxRate         Decimal @default(0) @map("tax_rate") @db.Decimal(5, 2)
  taxAmount       Decimal @default(0) @map("tax_amount") @db.Decimal(15, 2)

  // Totales
  subtotal        Decimal @db.Decimal(15, 2)
  lineTotal       Decimal @map("line_total") @db.Decimal(15, 2)

  // Costo (para c√°lculo de margen)
  unitCost        Decimal? @map("unit_cost") @db.Decimal(15, 4)
  totalCost       Decimal? @map("total_cost") @db.Decimal(15, 2)

  // Flag para saber si el precio incluye IVA
  priceIncludesTax Boolean @default(true) @map("price_includes_tax")

  metadata        Json    @default("{}")
  createdAt       DateTime @default(now()) @map("created_at")

  // Relations
  sale    Sale     @relation(fields: [saleId], references: [id], onDelete: Cascade)
  product Product? @relation(fields: [productId], references: [id])

  @@map("sale_items")
}

// üí≥ PAGOS DE VENTA
model SalePayment {
  id                String   @id @default(cuid())
  saleId            String   @map("sale_id")
  paymentMethodId   String   @map("payment_method_id")
  paymentMethodName String   @map("payment_method_name")

  // Monto
  amount            Decimal  @db.Decimal(15, 2)

  // Referencias (cheque, transferencia, etc)
  reference         String?
  referenceDate     DateTime? @map("reference_date")

  // Estado del pago
  status            String   @default("completed") // pending, completed, cancelled
  collectionDate    DateTime? @map("collection_date") // Fecha efectiva de cobro

  // Notas
  notes             String?
  metadata          Json     @default("{}")

  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  sale          Sale          @relation(fields: [saleId], references: [id], onDelete: Cascade)
  paymentMethod PaymentMethod @relation(fields: [paymentMethodId], references: [id])
  cashMovements CashMovement[] @relation("CashMovementSalePayment")

  @@index([saleId])
  @@index([paymentMethodId])
  @@index([status])
  @@index([collectionDate])
  @@map("sale_payments")
}

// üßæ CONFIGURACI√ìN AFIP
model AfipConfiguration {
  id              String   @id @default(cuid())
  tenantId        String   @unique @map("tenant_id")

  // Credenciales
  cuit            String
  certificatePath String?  @map("certificate_path")
  privateKeyPath  String?  @map("private_key_path")
  certificate     String?  @db.Text // Contenido del certificado
  privateKey      String?  @map("private_key") @db.Text // Contenido de la clave privada

  // Ambiente
  environment     String   @default("testing") // testing, production

  // Puntos de venta
  salesPoints     Json     @default("[]") @map("sales_points") // [{ pointOfSale: 1, lastNumber: 0, voucherType: "FC_A" }]

  // Token de acceso (cache)
  accessToken     String?  @map("access_token") @db.Text
  tokenExpiry     DateTime? @map("token_expiry")

  // Estado
  isActive        Boolean  @default(false) @map("is_active")
  lastSync        DateTime? @map("last_sync")

  metadata        Json     @default("{}")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("afip_configurations")
}

// üè¢ SUCURSALES
model Branch {
  id           String   @id @default(cuid())
  tenantId     String   @map("tenant_id")
  code         String
  name         String
  addressLine1 String?  @map("address_line1")
  addressLine2 String?  @map("address_line2")
  city         String?
  state        String?
  postalCode   String?  @map("postal_code")
  phone        String?
  email        String?
  isDefault    Boolean  @default(false) @map("is_default")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  tenant                Tenant                   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  voucherConfigurations VoucherConfiguration[]
  sales                 Sale[]                   @relation("SaleBranch")
  salesPoints           SalesPoint[]

  @@unique([tenantId, code])
  @@map("branches")
}

// üîå CONEXIONES AFIP
model AfipConnection {
  id          String   @id @default(cuid())
  tenantId    String   @map("tenant_id")
  name        String
  description String?
  cuit        String
  environment String   @default("testing") // 'testing' | 'production'
  certificate String?  @db.Text
  privateKey  String?  @map("private_key") @db.Text
  wsaaUrl     String?  @map("wsaa_url") // URL del servicio WSAA (auth)
  wsfeUrl     String?  @map("wsfe_url") // URL del servicio WSFEv1 (facturaci√≥n)
  timeout     Int?     @default(30000) // Timeout en milisegundos (default 30 segundos)
  isActive    Boolean  @default(true) @map("is_active")
  lastTest    DateTime? @map("last_test") // √öltima vez que se prob√≥ la conexi√≥n
  lastTestStatus String? @map("last_test_status") // 'success' | 'error'
  // Ticket de Acceso (TA) de WSAA
  taToken     String?  @map("ta_token") @db.Text // Token del TA
  taSign      String?  @map("ta_sign") @db.Text // Firma del TA
  taExpiresAt DateTime? @map("ta_expires_at") // Fecha de expiraci√≥n del TA
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  tenant                Tenant                   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  voucherConfigurations VoucherConfiguration[]

  @@map("afip_connections")
}

// üìä PUNTOS DE VENTA AFIP
model SalesPoint {
  id          String   @id @default(cuid())
  tenantId    String   @map("tenant_id")
  branchId    String?  @map("branch_id")
  number      Int
  name        String
  description String?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  tenant                Tenant                   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  branch                Branch?                  @relation(fields: [branchId], references: [id], onDelete: SetNull)
  voucherConfigurations VoucherConfiguration[]

  @@unique([tenantId, number])
  @@map("sales_points")
}

// üìÑ TIPOS DE COMPROBANTE
model VoucherType {
  id               String   @id @default(cuid())
  code             String   @unique
  name             String
  letter           String
  documentClass    String   @map("document_class") // 'INVOICE', 'CREDIT_NOTE', 'DEBIT_NOTE', 'QUOTE'
  afipCode         Int?     @map("afip_code")
  requiresCae      Boolean  @default(false) @map("requires_cae")
  discriminatesVat Boolean  @default(false) @map("discriminates_vat")
  isActive         Boolean  @default(true) @map("is_active")
  createdAt        DateTime @default(now()) @map("created_at")

  // Relations
  voucherConfigurations VoucherConfiguration[]
  sales                 Sale[]

  @@map("voucher_types")
}

// ‚öôÔ∏è CONFIGURACI√ìN DE COMPROBANTES
model VoucherConfiguration {
  id                 String   @id @default(cuid())
  tenantId           String   @map("tenant_id")
  voucherTypeId      String   @map("voucher_type_id")
  branchId           String?  @map("branch_id")
  afipConnectionId   String?  @map("afip_connection_id")
  salesPointId       String?  @map("sales_point_id")
  nextVoucherNumber  Int      @default(1) @map("next_voucher_number")
  isActive           Boolean  @default(true) @map("is_active")
  isDefault          Boolean  @default(false) @map("is_default") // Indica si es la configuraci√≥n por defecto para el tipo de comprobante
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  // Relations
  tenant         Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  voucherType    VoucherType     @relation(fields: [voucherTypeId], references: [id])
  branch         Branch?         @relation(fields: [branchId], references: [id])
  afipConnection AfipConnection? @relation(fields: [afipConnectionId], references: [id])
  salesPoint     SalesPoint?     @relation(fields: [salesPointId], references: [id])
  sales          Sale[]

  @@unique([tenantId, voucherTypeId, branchId])
  @@map("voucher_configurations")
}

// üõí COMPRAS
model Purchase {
  id              String   @id @default(cuid())
  tenantId        String   @map("tenant_id")
  purchaseNumber  String   @map("purchase_number")
  purchaseDate    DateTime @default(now()) @map("purchase_date") @db.Date
  supplierId      String   @map("supplier_id")
  supplierName    String   @map("supplier_name")

  // N√∫mero de factura del proveedor
  invoiceNumber   String?  @map("invoice_number")
  invoiceDate     DateTime? @map("invoice_date") @db.Date

  // Montos
  subtotal        Decimal  @default(0) @db.Decimal(15, 2)
  discountAmount  Decimal  @default(0) @map("discount_amount") @db.Decimal(15, 2)
  taxAmount       Decimal  @default(0) @map("tax_amount") @db.Decimal(15, 2)
  totalAmount     Decimal  @default(0) @map("total_amount") @db.Decimal(15, 2)

  // Estado de pago
  paidAmount      Decimal  @default(0) @map("paid_amount") @db.Decimal(15, 2)
  balanceAmount   Decimal  @default(0) @map("balance_amount") @db.Decimal(15, 2)
  paymentStatus   String   @default("pending") @map("payment_status") // pending, partial, paid

  // Almac√©n donde se ingresa el stock
  warehouseId     String   @map("warehouse_id")

  // Descuento a nivel compra
  discountPercent Decimal  @default(0) @map("discount_percent") @db.Decimal(5, 2)

  // Metadatos
  notes           String?
  metadata        Json     @default("{}")

  // Auditor√≠a
  status          String   @default("completed") // draft, completed, cancelled
  createdBy       String   @map("created_by")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  tenant    Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  supplier  Entity          @relation("PurchaseSupplier", fields: [supplierId], references: [id])
  warehouse Warehouse       @relation("PurchaseWarehouse", fields: [warehouseId], references: [id])
  creator   User            @relation("PurchaseCreatedBy", fields: [createdBy], references: [id])
  items     PurchaseItem[]
  payments  PurchasePayment[]
  cashMovements CashMovement[] @relation("CashMovementPurchase")

  @@unique([tenantId, purchaseNumber])
  @@index([tenantId, purchaseDate])
  @@index([tenantId, paymentStatus])
  @@index([supplierId])
  @@map("purchases")
}

// üìù ITEMS DE COMPRA
model PurchaseItem {
  id              String  @id @default(cuid())
  purchaseId      String  @map("purchase_id")
  lineNumber      Int     @map("line_number")
  productId       String? @map("product_id")
  productSku      String? @map("product_sku")
  productName     String  @map("product_name")
  description     String?
  expirationDate  DateTime? @map("expiration_date") @db.Date

  // Cantidades y precios
  quantity        Decimal @db.Decimal(15, 4)
  unitPrice       Decimal @map("unit_price") @db.Decimal(15, 4)
  discountPercent Decimal @default(0) @map("discount_percent") @db.Decimal(5, 2)
  discountAmount  Decimal @default(0) @map("discount_amount") @db.Decimal(15, 2)

  // Impuestos
  taxRate         Decimal @default(0) @map("tax_rate") @db.Decimal(5, 2)
  taxAmount       Decimal @default(0) @map("tax_amount") @db.Decimal(15, 2)

  // Totales
  subtotal        Decimal @db.Decimal(15, 2)
  lineTotal       Decimal @map("line_total") @db.Decimal(15, 2)

  metadata        Json    @default("{}")
  createdAt       DateTime @default(now()) @map("created_at")

  // Relations
  purchase Purchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  product  Product? @relation("PurchaseItemProduct", fields: [productId], references: [id])

  @@map("purchase_items")
}

// üí≥ PAGOS DE COMPRA
model PurchasePayment {
  id                String   @id @default(cuid())
  purchaseId        String   @map("purchase_id")
  paymentMethodId   String   @map("payment_method_id")
  paymentMethodName String   @map("payment_method_name")

  // Monto
  amount            Decimal  @db.Decimal(15, 2)

  // Referencias (cheque, transferencia, etc)
  reference         String?
  referenceDate     DateTime? @map("reference_date")

  // Estado del pago
  status            String   @default("completed") // pending, completed, cancelled
  paymentDate       DateTime? @map("payment_date") // Fecha efectiva de pago

  // Notas
  notes             String?
  metadata          Json     @default("{}")

  createdBy         String   @map("created_by")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  purchase      Purchase      @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  paymentMethod PaymentMethod @relation("PurchasePaymentMethod", fields: [paymentMethodId], references: [id])
  creator       User          @relation("PurchasePaymentCreatedBy", fields: [createdBy], references: [id])
  cashMovements CashMovement[] @relation("CashMovementPurchasePayment")

  @@index([purchaseId])
  @@index([paymentMethodId])
  @@index([status])
  @@index([paymentDate])
  @@map("purchase_payments")
}

// üí∞ CUENTAS DE CAJA/BANCO
model CashAccount {
  id          String   @id @default(cuid())
  tenantId    String   @map("tenant_id")

  // Informaci√≥n b√°sica
  name        String
  description String?
  accountType String   @map("account_type") // cash, bank, mercadopago, etc.

  // Estado
  isActive    Boolean  @default(true) @map("is_active")
  isDefault   Boolean  @default(false) @map("is_default") // Cuenta por defecto

  // Balance inicial (para arqueo)
  initialBalance Decimal @default(0) @map("initial_balance") @db.Decimal(15, 2)

  // Metadata
  metadata    Json     @default("{}")

  createdBy   String   @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  tenant       Tenant         @relation("CashAccountTenant", fields: [tenantId], references: [id], onDelete: Cascade)
  creator      User           @relation("CashAccountCreatedBy", fields: [createdBy], references: [id])
  movements    CashMovement[]
  paymentMethods PaymentMethod[] @relation("PaymentMethodCashAccount")

  @@index([tenantId])
  @@index([isActive])
  @@index([isDefault])
  @@map("cash_accounts")
}

// üí∏ MOVIMIENTOS DE CAJA
model CashMovement {
  id              String   @id @default(cuid())
  tenantId        String   @map("tenant_id")
  cashAccountId   String   @map("cash_account_id")

  // Tipo de movimiento
  movementType    String   @map("movement_type") // income, expense
  category        String   // sale, purchase, payment, withdrawal, deposit, adjustment, etc.

  // Monto
  amount          Decimal  @db.Decimal(15, 2)

  // Referencias
  description     String
  reference       String?  // N√∫mero de comprobante, transferencia, etc.

  // Relaciones opcionales con ventas/compras
  saleId          String?  @map("sale_id")
  purchaseId      String?  @map("purchase_id")
  salePaymentId   String?  @map("sale_payment_id")
  purchasePaymentId String? @map("purchase_payment_id")

  // M√©todo de pago asociado
  paymentMethodId String?  @map("payment_method_id")

  // Fecha del movimiento
  movementDate    DateTime @map("movement_date")

  // Notas
  notes           String?
  metadata        Json     @default("{}")

  createdBy       String   @map("created_by")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  tenant          Tenant         @relation("CashMovementTenant", fields: [tenantId], references: [id], onDelete: Cascade)
  cashAccount     CashAccount    @relation(fields: [cashAccountId], references: [id], onDelete: Cascade)
  sale            Sale?          @relation("CashMovementSale", fields: [saleId], references: [id], onDelete: SetNull)
  purchase        Purchase?      @relation("CashMovementPurchase", fields: [purchaseId], references: [id], onDelete: SetNull)
  salePayment     SalePayment?   @relation("CashMovementSalePayment", fields: [salePaymentId], references: [id], onDelete: SetNull)
  purchasePayment PurchasePayment? @relation("CashMovementPurchasePayment", fields: [purchasePaymentId], references: [id], onDelete: SetNull)
  paymentMethod   PaymentMethod? @relation("CashMovementPaymentMethod", fields: [paymentMethodId], references: [id], onDelete: SetNull)
  creator         User           @relation("CashMovementCreatedBy", fields: [createdBy], references: [id])

  @@index([tenantId])
  @@index([cashAccountId])
  @@index([movementType])
  @@index([category])
  @@index([movementDate])
  @@index([saleId])
  @@index([purchaseId])
  @@index([paymentMethodId])
  @@map("cash_movements")
}